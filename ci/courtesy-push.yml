steps:
- task: DownloadBuildArtifacts@0
  inputs:
    artifactName: IndividualNugetPackages
    downloadPath: 'IndividualNugetPackagesDownloaded'
  displayName: 'Download Artifact'

- script: dir

- script: node azure-pipelines-tasks\ci\courtesy-push.js AzureDevOps\.nuget\externals\UnifiedDependencies.xml IndividualNugetPackagesDownloaded\IndividualNugetPackages\unified_deps.xml
  displayName: 'Update unified deps'

- powershell: AzureDevOps\archive\Preinstall\StrongNameHijack.msi
  displayName: 'Prep env'

- script: |
    cd AzureDevOps
    init.cmd
    cd IndividualNugetPackagesDownloaded\IndividualNugetPackages
    push.cmd
  displayName: 'Push Nuget packages'

- powershell: |
      # Build the release branch name
      $startdate = Get-Date -Date '2020-01-20'
      $enddate = Get-Date
      $difference = New-TimeSpan -Start $startdate -End $enddate
      $sprintsSince165 = ($difference.Days/21) - (($difference.Days/21)%1) # Weirdly, PowerShell modulo is actually a remainder operator. This gets the actual modulo value.
      $currentSprint = $sprintsSince165 + 165
      $releaseBranch = "users/damccorm/m" + $currentSprint + "/courtesyPush"

      # Push branch to git
      cd AzureDevOps
      git checkout -b $releaseBranch
      git push origin $releaseBranch
