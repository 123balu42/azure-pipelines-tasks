steps:
- task: DownloadBuildArtifacts@0
  inputs:
    artifactName: IndividualNugetPackages
  displayName: 'Download Artifact'

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: '$(System.ArtifactsDirectory)/IndividualNugetPackages.zip'
    destinationFolder: IndividualNugetPackagesDownloaded
    cleanDestinationFolder: true 
  displayName: 'Extract artifact'

- bash: ls -R IndividualNugetPackagesDownloaded

- script: init.cmd
  displayName: 'Initialize Environment'

- script: node courtesy-push.js .nuget\externals\UnifiedDependencies.xml IndividualNugetPackagesDownloaded\IndividualNugetPackagesDownloaded\unified_deps.xml

- script: |
    cd IndividualNugetPackagesDownloaded\IndividualNugetPackagesDownloaded
    push.cmd
  displayName: 'Push Nuget packages'

- powershell: |
      # Build the release branch name
      $startdate = Get-Date -Date '2020-01-20'
      $enddate = Get-Date
      $difference = New-TimeSpan -Start $startdate -End $enddate
      $sprintsSince165 = ($difference.Days/21) - (($difference.Days/21)%1) # Weirdly, PowerShell modulo is actually a remainder operator. This gets the actual modulo value.
      $currentSprint = $sprintsSince165 + 165
      $releaseBranch = "users/damccorm/m" + $currentSprint + "/courtesyPush"

      # Push branch to git
      git checkout -b $releaseBranch
      git push origin $releaseBranch