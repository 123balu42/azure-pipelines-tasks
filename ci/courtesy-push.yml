steps:
- task: NuGetToolInstaller@0
  inputs:
    versionSpec: '4.3.0'
  displayName: 'Install nuget'

- task: DownloadBuildArtifacts@0
  inputs:
    artifactName: IndividualNugetPackages
    downloadPath: 'IndividualNugetPackagesDownloaded'
  displayName: 'Download Artifact'

- script: dir

- script: node azure-pipelines-tasks\ci\courtesy-push.js AzureDevOps\.nuget\externals\UnifiedDependencies.xml IndividualNugetPackagesDownloaded\IndividualNugetPackages\unified_deps.xml
  displayName: 'Update unified deps'

- script: |
    cd IndividualNugetPackagesDownloaded
    dir
    cd IndividualNugetPackages
    dir
    nuget setapikey %API_KEY% -source https://mseng.pkgs.visualstudio.com/_packaging/Codex-Deps/nuget/v3/index.json
    push.cmd
  displayName: 'Push Nuget packages'
  env:
    API_KEY: $(ApiKey)

- powershell: |
      # Build the release branch name
      $startdate = Get-Date -Date '2020-01-20'
      $enddate = Get-Date
      $difference = New-TimeSpan -Start $startdate -End $enddate
      $sprintsSince165 = ($difference.Days/21) - (($difference.Days/21)%1) # Weirdly, PowerShell modulo is actually a remainder operator. This gets the actual modulo value.
      $currentSprint = $sprintsSince165 + 165
      $releaseBranch = "users/damccorm/m" + $currentSprint + "/courtesyPush"

      # Push branch to git
      cd AzureDevOps
      git checkout -b $releaseBranch
      git push origin $releaseBranch
