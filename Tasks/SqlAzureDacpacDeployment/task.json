{
	"id": "CE85A08B-A538-4D2B-8589-1D37A9AB970F",
	"name": "SqlAzureDacpacDeployment",
	"friendlyName": "Azure SQL Database Deployment",
	"description": "Deploy Azure SQL Database using DACPAC",
	"helpMarkDown": "[More Information](https://github.com/Microsoft/vso-agent-tasks/blob/master/Tasks/SqlAzureDacpacDeployment/README.md)",
	"category": "Deploy",
	"visibility": [
		"Preview",
		"Build",
		"Release"
	],
	"author": "Microsoft Corporation",
	"version": {
		"Major": 1,
		"Minor": 0,
		"Patch": 2
	},
	"demands": [
        "azureps",
        "sqlpackage"
	],
	"minimumAgentVersion": "1.87.0",
	"groups": [
		{
			"name": "source",
			"displayName": "Source",
			"isExpanded": true
		},
		{
			"name": "target",
			"displayName": "Target",
			"isExpanded": true
		},
		{
			"name": "firewall",
			"displayName": "Firewall",
			"isExpanded": false
		}
	],
	"inputs": [
		{
			"name": "ConnectedServiceName",
			"type": "connectedService:Azure",
			"label": "Azure Subscription",
			"defaultValue": "",
			"required": true,
			"helpMarkDown": "Azure subscription to target for the deployment."
		},
		{
			"name": "DacpacFile",
			"type": "string",
			"label": "DACPAC File",
			"required": true,
			"groupName": "source",
			"defaultValue": "",
			"helpMarkDown": "Location of the DACPAC file on the automation agent or on a UNC path accessible to the automation agent like, \\BudgetIT\\Web\\Deploy\\FabrikamDB.dacpac. Predefined variables like, $(agent.releaseDirectory), can be also used here."
		},
		{
			"name": "ServerName",
			"type": "string",
			"label": "Server Name",
			"required": true,
			"groupName": "target",
			"defaultValue": "",
			"helpMarkDown": "Azure SQL Database connection string like, FabrikamSQL.database.windows.net, 1433."
		},
		{
			"name": "DatabaseName",
			"type": "string",
			"label": "Database Name",
			"required": true,
			"groupName": "target",
			"defaultValue": "",
			"helpMarkDown": "Name of the Azure SQL Database."
		},
		{
			"name": "SqlUsername",
			"type": "string",
			"label": "SQL Username",
			"required": false,
			"groupName": "target",
			"defaultValue": "",
			"helpMarkDown": "Azure SQL Database uses SQL Server authentication. Specify the Azure SQL Database administrator login."
		},
		{
			"name": "SqlPassword",
			"type": "string",
			"label": "SQL Password",
			"required": false,
			"groupName": "target",
			"defaultValue": "",
			"helpMarkDown": "Password for the Azure SQL Database administrator."
		},
		{
			"name": "PublishProfile",
			"type": "string",
			"label": "Publish Profile",
			"required": false,
			"groupName": "target",
			"defaultValue": "",
			"helpMarkDown": "Publish profile provide fine-grained control over Azure SQL Database creation or upgrades. Specify the path to the Publish profile XML file on the automation agent or on a UNC share."
		},
		{
			"name": "AdditionalArguments",
			"type": "string",
			"label": "Additional SqlPackage.exe Arguments",
			"required": false,
			"groupName": "target",
			"defaultValue": "",
			"helpMarkDown": "Additional SqlPackage.exe arguments that will be applied when creating or updating the Azure SQL Database like, /p:IgnoreAnsiNulls=True /p:IgnoreComments=True. These arguments will override the settings in the Publish profile XML file (if provided).â€‹"
		},
		{
			"name": "IpDetectionMethod",
			"type": "pickList",
			"label": "Specify Firewall Rules Using",
			"required": true,
            "groupName": "firewall",
            "defaultValue": "IPAddressRange",
			"helpMarkDown": "For the task to run, the IP Address of the automation agent has to be added to the 'Allowed IP Addresses' in the Server's Firewall. Provide the IP Address range of the automation agents or select to auto-detect the IP Address of the agent where the tasks runs."
		},
		{
			"name": "StartIpAddress",
			"type": "string",
			"label": "Start IP Address",
			"required": true,
			"groupName": "firewall",
			"defaultValue": "",
			"visibleRule": "IpDetectionMethod = IPAddressRange",
			"helpMarkDown": "The starting IP Address of the automation agent machine pool."
		},
		{
			"name": "EndIpAddress",
			"type": "string",
			"label": "End IP Address",
			"required": true,
			"groupName": "firewall",
			"defaultValue": "",
			"visibleRule": "IpDetectionMethod = IPAddressRange",
			"helpMarkDown": "The ending IP Address of the automation agent machine pool."
		},
		{
			"name": "DeleteFirewallRule",
			"type": "boolean",
			"label": "Delete Rule After Task Ends",
			"required": false,
			"groupName": "firewall",
			"defaultValue": "true",
			"helpMarkDown": "If selected, after the task ends, the IP Addresses specified here are deleted from the 'Allowed IP Addresses' list of the Server's Firewall."
		}
	],	
    "sourceDefinitions": [ 
     { 
         "target": "IpDetectionMethod", 
         "endpoint": "/_apis/vslabs/ipAddress/ipDetectionMethods", 
         "selector": "jsonpath:$.value[*]", 
         "authKey": "tfs:DevTestLabs" 
     } 
    ], 
	"instanceNameFormat": "Deploy Azure SQL DACPAC: $(DacpacFile)",
	"execution": {
		"AzurePowerShell": {
			"target": "$(currentDirectory)\\DeploySqlAzure.ps1",
			"argumentFormat": "",
			"workingDirectory": "$(currentDirectory)"
		}
	}
}